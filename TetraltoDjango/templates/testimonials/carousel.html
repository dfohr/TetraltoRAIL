{% load static %}

<!-- Testimonials Carousel - Uses JSON-LD structured data -->
<div class="testimonials-carousel" id="{{ carousel_id }}" 
     role="region" aria-label="Customer testimonials" aria-live="polite">
    
    <!-- Carousel slides populated by JavaScript from JSON-LD structured data -->
    <div class="carousel-wrapper"></div>
    
    <!-- Navigation dots populated by JavaScript -->
    <div class="carousel-navigation" role="tablist" aria-label="Testimonial navigation"></div>
    
    <!-- Loading state -->
    <div class="carousel-loading" style="display: none;">Loading testimonials...</div>
    
    <!-- Empty state (shown by JavaScript if no data found) -->
    <div class="carousel-empty" style="display: none;">
        <p>No testimonials available.</p>
    </div>
</div>


<!-- Enhanced JavaScript for carousel functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('{{ carousel_id }}');
    if (!carousel) return;
    
    const wrapper = carousel.querySelector('.carousel-wrapper');
    const navigation = carousel.querySelector('.carousel-navigation');
    const loading = carousel.querySelector('.carousel-loading');
    
    // Get testimonials from structured data (single source of truth)
    const structuredDataScript = document.querySelector('script[type="application/ld+json"]');
    let testimonials = [];
    
    if (structuredDataScript) {
        try {
            const structuredData = JSON.parse(structuredDataScript.textContent);
            
            // Parse JSON-LD ItemList format into carousel format
            if (structuredData.itemListElement && Array.isArray(structuredData.itemListElement)) {
                testimonials = structuredData.itemListElement.map(item => {
                    const review = item.item;
                    return {
                        id: item.position, // Use position as ID
                        name: review.author?.name || 'Anonymous',
                        text: review.reviewBody || '',
                        city: review.author?.address?.addressLocality || '',
                        service: 'Roofing Services', // Default service since not in JSON-LD
                        rating: review.reviewRating?.ratingValue || 5,
                        url: review.url || '',
                        created_at: review.datePublished || '',
                        is_featured: true // All structured data testimonials are featured
                    };
                });
            }
        } catch (error) {
            console.warn('Failed to parse testimonials structured data:', error);
        }
    }
    
    if (!testimonials || testimonials.length === 0) {
        // Show empty state and hide loading
        if (loading) loading.style.display = 'none';
        const emptyState = carousel.querySelector('.carousel-empty');
        if (emptyState) emptyState.style.display = 'block';
        return;
    }
    
    // Helper function to validate URL scheme for security
    function isValidUrl(url) {
        if (!url) return false;
        try {
            const urlObj = new URL(url);
            return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
        } catch {
            return false;
        }
    }
    
    // Helper function to safely create DOM elements with text content (prevents XSS)
    function createElement(tag, attributes = {}, textContent = '') {
        const element = document.createElement(tag);
        for (const [key, value] of Object.entries(attributes)) {
            element.setAttribute(key, value);
        }
        if (textContent) {
            element.textContent = textContent;
        }
        return element;
    }
    
    // Build carousel using secure DOM creation (prevents innerHTML XSS)
    const slides = [];
    const dots = [];
    
    testimonials.forEach((testimonial, index) => {
        const isActive = index === 0;
        const stars = '⭐'.repeat(Math.max(0, Math.min(5, parseInt(testimonial.rating) || 5)));
        
        // Create slide container
        const slideDiv = createElement('div', {
            'class': `testimonial-slide${isActive ? ' active' : ''}`,
            'data-slide': index,
            'aria-hidden': !isActive,
            'role': 'tabpanel',
            'aria-labelledby': `testimonial-${index}-tab`
        });
        
        // Create content container
        const contentDiv = createElement('div', { 'class': 'testimonial-content' });
        
        // Create rating stars
        const ratingDiv = createElement('div', {
            'class': 'rating-stars',
            'aria-label': `${testimonial.rating} out of 5 stars`
        });
        ratingDiv.textContent = stars;
        
        const ratingSpan = createElement('span', {
            'class': 'rating-value',
            'aria-hidden': 'true'
        }, `(${testimonial.rating}/5)`);
        ratingDiv.appendChild(ratingSpan);
        
        // Create quote
        const quote = createElement('blockquote', { 'class': 'testimonial-quote' }, testimonial.text);
        
        // Create author section
        const authorDiv = createElement('div', { 'class': 'testimonial-author' });
        const authorStrong = createElement('strong', {}, testimonial.name);
        const authorLocation = createElement('span', { 'class': 'author-location' }, testimonial.city);
        const authorService = createElement('small', { 'class': 'author-service' }, testimonial.service);
        
        authorDiv.appendChild(authorStrong);
        authorDiv.appendChild(document.createElement('br'));
        authorDiv.appendChild(authorLocation);
        authorDiv.appendChild(document.createElement('br'));
        authorDiv.appendChild(authorService);
        
        // Assemble slide (main content first)
        contentDiv.appendChild(ratingDiv);
        contentDiv.appendChild(quote);
        contentDiv.appendChild(authorDiv);
        
        // Add review link at bottom with URL validation
        if (isValidUrl(testimonial.url)) {
            const reviewLink = createElement('a', {
                'href': testimonial.url,
                'target': '_blank',
                'rel': 'noopener',
                'class': 'review-link',
                'aria-label': `Read full review by ${testimonial.name} on external site`
            }, 'Read full review →');
            contentDiv.appendChild(reviewLink);
        }
        slideDiv.appendChild(contentDiv);
        
        wrapper.appendChild(slideDiv);
        slides.push(slideDiv);
        
        // Create navigation dot
        if (testimonials.length > 1) {
            const dotButton = createElement('button', {
                'class': `nav-dot${isActive ? ' active' : ''}`,
                'data-slide': index,
                'role': 'tab',
                'id': `testimonial-${index}-tab`,
                'aria-selected': isActive,
                'aria-controls': `testimonial-slide-${index}`,
                'aria-label': `View testimonial ${index + 1} by ${testimonial.name}`
            });
            
            navigation.appendChild(dotButton);
            dots.push(dotButton);
        }
    });
    if (loading) loading.style.display = 'none';
    
    // Setup carousel functionality (use the slides/dots arrays we already created)
    const dotsElements = navigation.querySelectorAll('.nav-dot');
    let currentSlide = 0;
    let autoRotate;
    
    // Initialize auto-rotation if multiple slides
    if (slides.length > 1) {
        function startAutoRotate() {
            autoRotate = setInterval(() => {
                nextSlide();
            }, 10000);
        }
        
        function stopAutoRotate() {
            clearInterval(autoRotate);
        }
        
        startAutoRotate();
        
        // Pause on hover or focus
        carousel.addEventListener('mouseenter', stopAutoRotate);
        carousel.addEventListener('focusin', stopAutoRotate);
        
        // Resume on mouse leave or focus out
        carousel.addEventListener('mouseleave', startAutoRotate);
        carousel.addEventListener('focusout', (e) => {
            setTimeout(() => {
                if (!carousel.contains(document.activeElement)) {
                    startAutoRotate();
                }
            }, 100);
        });
        
        // Dot navigation with keyboard support
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                showSlide(index);
            });
            
            dot.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        showSlide(index > 0 ? index - 1 : slides.length - 1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        showSlide(index < slides.length - 1 ? index + 1 : 0);
                        break;
                    case 'Home':
                        e.preventDefault();
                        showSlide(0);
                        break;
                    case 'End':
                        e.preventDefault();
                        showSlide(slides.length - 1);
                        break;
                }
            });
        });
    }
    
    function showSlide(index) {
        // Update visual state
        slides.forEach((slide, i) => {
            slide.classList.toggle('active', i === index);
            slide.setAttribute('aria-hidden', i === index ? 'false' : 'true');
        });
        
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
            dot.setAttribute('aria-selected', i === index ? 'true' : 'false');
        });
        
        currentSlide = index;
        
        // Announce to screen readers
        const testimonial = testimonials[index];
        carousel.setAttribute('aria-label', `Customer testimonials. Currently showing testimonial ${index + 1} of ${slides.length} by ${testimonial.name}`);
    }
    
    function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
    }
    
    // Initialize first slide announcement
    if (slides.length > 0) {
        showSlide(0);
    }
});
</script>