{% load static %}

<!-- Testimonials Carousel - Uses Django-filtered data -->
<div class="testimonials-carousel" id="{{ carousel_id }}" 
     role="region" aria-label="Customer testimonials" aria-live="polite">
    
    {% if testimonials %}
        <!-- Carousel slides populated by JavaScript from Django data -->
        <div class="carousel-wrapper"></div>
        
        <!-- Navigation dots populated by JavaScript -->
        <div class="carousel-navigation" role="tablist" aria-label="Testimonial navigation"></div>
        
        <!-- Loading state -->
        <div class="carousel-loading" style="display: none;">Loading testimonials...</div>
    {% else %}
        <div class="carousel-empty">
            <p>No testimonials available.</p>
        </div>
    {% endif %}
</div>


<!-- Enhanced JavaScript for carousel functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('{{ carousel_id }}');
    if (!carousel) return;
    
    const wrapper = carousel.querySelector('.carousel-wrapper');
    const navigation = carousel.querySelector('.carousel-navigation');
    const loading = carousel.querySelector('.carousel-loading');
    
    // Get testimonials from structured data (single source of truth)
    const structuredDataScript = document.querySelector('script[type="application/ld+json"]');
    let testimonials = [];
    
    if (structuredDataScript) {
        try {
            const structuredData = JSON.parse(structuredDataScript.textContent);
            
            // Parse JSON-LD ItemList format into carousel format
            if (structuredData.itemListElement && Array.isArray(structuredData.itemListElement)) {
                testimonials = structuredData.itemListElement.map(item => {
                    const review = item.item;
                    return {
                        id: item.position, // Use position as ID
                        name: review.author?.name || 'Anonymous',
                        text: review.reviewBody || '',
                        city: review.author?.address?.addressLocality || '',
                        service: 'Roofing Services', // Default service since not in JSON-LD
                        rating: review.reviewRating?.ratingValue || 5,
                        url: review.url || '',
                        created_at: review.datePublished || '',
                        is_featured: true // All structured data testimonials are featured
                    };
                });
            }
        } catch (error) {
            console.warn('Failed to parse testimonials structured data:', error);
        }
    }
    
    if (!testimonials || testimonials.length === 0) {
        return; // Empty state already handled by Django template
    }
    
    // Build carousel HTML
    let slidesHTML = '';
    let dotsHTML = '';
    
    testimonials.forEach((testimonial, index) => {
        const isActive = index === 0;
        const stars = '⭐'.repeat(testimonial.rating);
        
        slidesHTML += `
            <div class="testimonial-slide${isActive ? ' active' : ''}" 
                 data-slide="${index}" 
                 aria-hidden="${!isActive}"
                 role="tabpanel"
                 aria-labelledby="testimonial-${index}-tab">
                <div class="testimonial-content">
                    <div class="rating-stars" aria-label="${testimonial.rating} out of 5 stars">
                        ${stars}
                        <span class="rating-value" aria-hidden="true">(${testimonial.rating}/5)</span>
                    </div>
                    <blockquote class="testimonial-quote">${testimonial.text}</blockquote>
                    <div class="testimonial-author">
                        <strong>${testimonial.name}</strong><br>
                        <span class="author-location">${testimonial.city}</span><br>
                        <small class="author-service">${testimonial.service}</small>
                    </div>
                    <a href="${testimonial.url}" target="_blank" rel="noopener" class="review-link" 
                       aria-label="Read full review by ${testimonial.name} on external site">
                        Read full review →
                    </a>
                </div>
            </div>
        `;
        
        if (testimonials.length > 1) {
            dotsHTML += `
                <button class="nav-dot${isActive ? ' active' : ''}" 
                        data-slide="${index}" 
                        role="tab"
                        id="testimonial-${index}-tab"
                        aria-selected="${isActive}"
                        aria-controls="testimonial-slide-${index}"
                        aria-label="View testimonial ${index + 1} by ${testimonial.name}">
                </button>
            `;
        }
    });
    
    // Populate carousel
    wrapper.innerHTML = slidesHTML;
    navigation.innerHTML = dotsHTML;
    if (loading) loading.style.display = 'none';
    
    // Setup carousel functionality
    const slides = wrapper.querySelectorAll('.testimonial-slide');
    const dots = navigation.querySelectorAll('.nav-dot');
    let currentSlide = 0;
    let autoRotate;
    
    // Initialize auto-rotation if multiple slides
    if (slides.length > 1) {
        function startAutoRotate() {
            autoRotate = setInterval(() => {
                nextSlide();
            }, 10000);
        }
        
        function stopAutoRotate() {
            clearInterval(autoRotate);
        }
        
        startAutoRotate();
        
        // Pause on hover or focus
        carousel.addEventListener('mouseenter', stopAutoRotate);
        carousel.addEventListener('focusin', stopAutoRotate);
        
        // Resume on mouse leave or focus out
        carousel.addEventListener('mouseleave', startAutoRotate);
        carousel.addEventListener('focusout', (e) => {
            setTimeout(() => {
                if (!carousel.contains(document.activeElement)) {
                    startAutoRotate();
                }
            }, 100);
        });
        
        // Dot navigation with keyboard support
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                showSlide(index);
            });
            
            dot.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        showSlide(index > 0 ? index - 1 : slides.length - 1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        showSlide(index < slides.length - 1 ? index + 1 : 0);
                        break;
                    case 'Home':
                        e.preventDefault();
                        showSlide(0);
                        break;
                    case 'End':
                        e.preventDefault();
                        showSlide(slides.length - 1);
                        break;
                }
            });
        });
    }
    
    function showSlide(index) {
        // Update visual state
        slides.forEach((slide, i) => {
            slide.classList.toggle('active', i === index);
            slide.setAttribute('aria-hidden', i === index ? 'false' : 'true');
        });
        
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
            dot.setAttribute('aria-selected', i === index ? 'true' : 'false');
        });
        
        currentSlide = index;
        
        // Announce to screen readers
        const testimonial = testimonials[index];
        carousel.setAttribute('aria-label', `Customer testimonials. Currently showing testimonial ${index + 1} of ${slides.length} by ${testimonial.name}`);
    }
    
    function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
    }
    
    // Initialize first slide announcement
    if (slides.length > 0) {
        showSlide(0);
    }
});
</script>