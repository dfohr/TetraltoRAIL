# TetraltoRail Deployment Chronicle

This document tracks our deployment process, challenges encountered, and solutions implemented for the TetraltoRail project.

## Project Overview

- **Project Name**: TetraltoRail
- **Main Application**: TetraltoDjango
- **Deployment Platform**: Railway.app
- **Repository**: [TetraltoRAIL on GitHub](https://github.com/dfohr/TetraltoRAIL)

## Deployment History

### April 9, 2025 - Google Tag Manager Integration and Content Updates

**Changes**:
1. Implemented Google Tag Manager for improved analytics tracking:
   - Added GTM container code to the application
   - Configured two Google tags within GTM container
   - Enhanced tracking capabilities while maintaining clean codebase

2. Added two new blog posts:
   - Expanded content library with relevant roofing information
   - Optimized blog content for SEO and user engagement

**Benefits**:
- More flexible analytics management without requiring code changes
- Better tracking of user interactions and conversion events
- Richer content offerings to improve SEO and user engagement

### April 2025 - Initial Deployment

_Initial deployment details to be filled in..._

### April 11, 2025 - Geolocation Service Deployment

**Changes**:
1. Added new geolocation microservice:
   - FastAPI-based service for IP geolocation
   - Uses MaxMind's web service
   - Configured for Railway deployment
   - Internal networking enabled for service-to-service communication

**Benefits**:
- Enhanced location-based features
- Improved service architecture
- Better separation of concerns

### April 11, 2025 - SSH Connectivity and Production Server Configuration

**Issues**:
1. SSH access to TetraltoDjango service was lost after git-based deployments
2. Service remained accessible via web but SSH connections failed
3. Other services (Postgres, geo-service) maintained SSH access

**Investigation**:
- Issue occurred specifically after git-based deployments that triggered simultaneous redeployment of multiple services
- Direct deployments using `railway up` maintained SSH access
- Error message indicated protocol-level connection issues

**Solution**:
1. Switched to Railpack builder for TetraltoDjango service
2. Configured proper production server using Gunicorn
3. Moved data loading to start command for better visibility
4. Maintained consistent deployment configuration

**Results**:
- SSH access restored to all services
- Production-grade server configuration implemented
- More reliable deployment process established
- Better visibility into deployment steps

**Lessons Learned**:
- Different deployment methods (git vs direct) can affect service configurations differently
- Railpack provides more stable service configuration for Django applications
- Production server configuration is essential for reliable service operation

### April 11, 2025 - Deployment Method Observations

**Behavior Differences**:
1. `railway up` deployment:
   - Direct deployment to specific service
   - Maintains SSH access to all services
   - More isolated deployment process

2. Git-based deployment:
   - Triggers redeployment of all services
   - May affect service configurations differently
   - More comprehensive but potentially disruptive

## Deployment Challenges and Solutions

### April 2025 - Railway CLI Upload Size Limitations

**Issue**: 
When attempting to deploy using `railway up`, we encountered timeout errors. Investigation revealed our project size is approximately 117MB, which exceeds Railway's 45MB upload limit for direct deployments.

**Project Size Analysis**:
- Total project size: 117MB
- Static files: 57MB (primarily large blog images)
- Staticfiles directory: 59MB (duplicates of static files generated by collectstatic)

**Solution**:
Switching to GitHub-based deployments to:
1. Only deploy changed files, bypassing the 45MB limit
2. Improve deployment reliability
3. Maintain better version control and rollback capabilities

**Next Steps**:
1. Connect the GitHub repository to Railway
2. Configure proper deployment settings in Railway dashboard
3. Consider moving large static assets to a CDN in the future
4. Optimize image files to reduce overall project size

### April 2025 - SSH Access and Name Collision Issues

**Issue**:
We encountered difficulties establishing SSH access to our Railway deployment. Initial attempts to connect via SSH failed, and we suspected configuration issues with the service.

**Investigation**:
After multiple troubleshooting attempts, we identified that a name collision between our service configurations was causing the problem. The build process was getting confused by conflicting configuration files or service names.

**Solution**:
1. Removed problematic pre-deploy commands from our configuration
2. Simplified the deployment configuration to avoid name collisions
3. Switched from Railpack to Nixpacks as the builder, which provided a more standardized build process
4. Ensured consistent naming across all configuration files and environment variables

**Result**:
Successfully established SSH access to the deployed application, which provides:
1. Direct troubleshooting capabilities in the production environment
2. Ability to examine logs and file structures in real-time
3. Option to perform emergency fixes when needed
4. Better visibility into how our application is running in production

**Lessons Learned**:
Consistent naming and simplified configuration are crucial for Railway deployments. When multiple configuration approaches overlap (like mixing Railpack and Nixpacks configurations), Railway may experience conflicts that prevent proper service execution and SSH access.

### April 7, 2025 - GitHub Integration for Deployment

**Plan**:
After determining that the Railway CLI upload method is not feasible due to our project size exceeding the 45MB limit, we're now preparing to connect TetraltoDjango to Railway via GitHub integration.

**Current Status**:
1. Created a checkpoint commit (13df4f7) that contains:
   - Our deployment chronicle documentation
   - Updated data export in data.json
   - New blog images for the algae streaks content
2. All changes pushed to the GitHub repository

**Next Steps**:
1. Connect our GitHub repository to Railway
2. Configure the deployment settings in Railway dashboard
3. Set up environment variables
4. Test the deployment process
5. Monitor the first GitHub-triggered deployment

**Rollback Information**:
If we encounter issues with this new deployment approach, we can revert to our current state using:
```bash
git reset --hard 13df4f7
```

This ensures we have a stable point to return to if the GitHub integration doesn't work as expected.

**Update - April 7, 2025**:
Successfully connected the GitHub repository to Railway with the following configuration:
1. Repository: dfohr/TetraltoRAIL
2. Root Directory: TetraltoDjango
3. Branch: main

The deployment worked perfectly on the first attempt. Specifying `TetraltoDjango` as the root directory was essential since our Django application is contained within this subdirectory rather than at the repository root. This approach allows us to maintain documentation and other files outside the application directory while still enabling smooth Railway deployment.

Benefits observed:
- Eliminated the timeout errors encountered with railway up
- Deployment process is faster and more reliable
- Changes automatically deploy when pushed to GitHub
- No need to manually run collectstatic or other commands

## Future Considerations for Microservices Architecture

As we plan to transition to a microservices architecture:

1. GitHub-based deployments will allow independent deployment of each service
2. Only changed services will be rebuilt and deployed
3. Individual services can have their own CI/CD workflows
4. Storage solutions for static assets will need to be implemented across services

## Deployment Environment Variables

| Variable Name | Purpose | Set In |
|---------------|---------|--------|
| RAILPACK_DJANGO_APP_NAME | Specifies the WSGI application | Railway Dashboard |
| RAILPACK_DJANGO_WORKDIR | Sets the working directory | Railway Dashboard |
| DATABASE_URL | Connection string for PostgreSQL | Railway Dashboard |
| DJANGO_SECRET_KEY | Secret key for Django | Railway Dashboard |
| DJANGO_DEBUG | Enable/disable debug mode | Railway Dashboard |

## Deployment Commands and Processes

**GitHub-based Deployment**:
1. Push changes to the GitHub repository
2. Railway automatically detects changes and rebuilds the service
3. Deployment logs can be viewed in the Railway dashboard

**Manual Deployment (for reference)**:
```bash
# This no longer works due to size limitations
railway up
```

**SSH Access**:
```bash
# Connect to the deployed service
railway ssh
``` 